<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Route Rules :: Kubernetes &amp; Istio Workshop</title>
    <link rel="canonical" href="https://github.com/Sfeir/kubernetes-istio-workshop/kubernetes-istio-workshop/1.0.0/istio/04_simple-routerules.html">
    <meta name="generator" content="Antora 1.1.1">
    <link rel="stylesheet" href="../../../_/css/site.css">
<link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon">  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a href="#">Kubernetes and Istio Workshop</a>
        <span class="separator">//</span>
        <a href="https://github.com/Sfeir/kubernetes-istio-workshop">Docs</a>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">Project</div>
          <div class="navbar-dropdown">
            <div class="navbar-item"><strong>GitHub</strong></div>
            <a class="navbar-item" href="https://github.com/Sfeir/kubernetes-istio-workshop/">Istio workshop Repository</a>
            <a class="navbar-item" href="https://github.com/Sfeir/kubernetes-istio-workshop//issues">Istio workshop Issue Tracker</a>
          </div>
        </div>
        <a class="navbar-item" href="https://twitter.com/sfeir">
          <span class="icon">
            <svg aria-hidden="true" data-icon="twitter" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
              <path fill="#57aaee" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path>
            </svg>
          </span>
        </a>
      </div>
    </div>
  </nav>
</header>
<div class="main-wrapper">
<div class="navigation-container" data-component="kubernetes-istio-workshop" data-version="1.0.0">
  <aside class="navigation">
    <div class="panels">
<div class="navigation-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Kubernetes and Istio Workshop</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../welcome/welcome.html"><strong>Welcome</strong></a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../welcome/welcome.html#gcp">1. Google Cloud Platform</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../welcome/welcome.html#cloud-shell">2. Setup Cloud Shell</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <span class="nav-text"><strong>Part 1 : Kubernetes</strong></span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../kubernetes/01_setup.html">1. Create cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../kubernetes/02_creating-and-managing-pods.html">2. Pods</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../kubernetes/03_monitoring-and-health-checks.html">3. Monitoring apps</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../kubernetes/04_managing-application-configurations-and-secrets.html">4. ConfigMaps &amp; Secrets</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../kubernetes/05_creating-and-managing-services.html">5. Services</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../kubernetes/06_creating-and-managing-deployments.html">6. Deployments</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../kubernetes/07_rolling-out-updates.html">7. Rolling-upgrade</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../kubernetes/08_cleanup.html">8. Cleanup</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <span class="nav-text"><strong>Part 2 : Istio</strong></span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="01_setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01_setup.html#prerequisites">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01_setup.html#deploy-istio">Deploy Istio</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01_setup.html#connect-cluster">Connect to the cluster</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01_setup.html#verify-installation">Verify installation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="02_deploy-microservices.html">2. Deploy Microservices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02_deploy-microservices.html#deploycustomer">Deploy Customer</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02_deploy-microservices.html#expose-customer">Expose Customer</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02_deploy-microservices.html#deploypreference">Deploy Preference</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02_deploy-microservices.html#deployrecommendation">Deploy Recommendation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="03_monitoring-tracing.html">3. Monitoring and Tracing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03_monitoring-tracing.html#monitoring">Monitoring</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03_monitoring-tracing.html#tracing">Tracing</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="04_simple-routerules.html">4. Simple Routing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#deployrecommendationv2">Deploy Recommendation V2</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="#istiorouting">Changing Istio Routings</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#alltorecommendationv2">All the traffic to recommendation:v2</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#alltorecommendationv1">Al the traffic to recommendation:v1</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#alltorecommendationv1v2">All Users To Recommendation V1 and V2</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#canarydeploymentrecommendation">Canary Deployment Between v1 And v2</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="05_advanced-routerules.html">5. Advanced Routing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05_advanced-routerules.html#traffic-steering">Traffic Steering</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05_advanced-routerules.html#loadbalancer">Load Balancer</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05_advanced-routerules.html#ratelimiting">Rate Limiting</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="06_fault-injection.html">6. Fault Injection</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06_fault-injection.html#503error">HTTP 503 Error</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06_fault-injection.html#delay">Delay</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06_fault-injection.html#retry">Retry</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06_fault-injection.html#timeout">Timeout</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="07_circuit-breaker.html">7. Circuit Breaker</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="07_circuit-breaker.html#failfast">Fail Fast</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="07_circuit-breaker.html#nocircuitbreaker">No Circuit Breaker</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="07_circuit-breaker.html#circuitbreaker">Circuit Breaker</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="07_circuit-breaker.html#poolejection">Pool Ejection</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="07_circuit-breaker.html#nofailinginstances">No Failing Instance</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="07_circuit-breaker.html#failinginstancesnopoolejection">Failing Instance No Pool Ejection</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="07_circuit-breaker.html#failinginstancespoolejection">Failing Instance Pool Ejection</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="07_circuit-breaker.html#circuitbreakerandpoolejection">Circuit Breaker + Pool Ejection</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="10_mTLS.html">8. Mutual TLS</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="10_mTLS.html#enablingtls">Enabling TLS</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <span class="nav-text"><strong>Bonus</strong></span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="08_egress.html">B1. Egress</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="08_egress.html#createrecommendationv3">Create Recommendation V3</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="08_egress.html#istioegress">Istio-ize Egress</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="09_virtualization.html">B2. Traffic Mirroring</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="09_virtualization.html#deploypreferencev2">Deploy Preference V2</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="09_virtualization.html#virtualize-dependencies">Virtualizing Dependencies</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="09_virtualization.html#mirroring-traffic">Mirroring Traffic</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="11_access-control.html#accesscontrol">B3. Access Control</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="11_access-control.html#whitelist">White List</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="11_access-control.html#blacklist">Black List</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="navigation-explore" data-panel="explore">
  <div class="context">
    <span class="title">Kubernetes and Istio Workshop</span>
    <span class="version">1.0.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Kubernetes and Istio Workshop</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1.0.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
  <main class="main">
<div class="toolbar" role="navigation">
  <button class="navigation-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="crumbs" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="../index.html">Kubernetes and Istio Workshop</a></li>
    <li class="crumb"><strong>Part 2 : Istio</strong></li>
    <li class="crumb"><a href="04_simple-routerules.html">4. Simple Routing</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///f/repo/external/github.com/sfeir/kubernetes-istio-workshop/src/documentation/modules/istio/pages/04_simple-routerules.adoc">Edit this Page</a></div>
</div>
<article class="doc">
<h1>Simple Route Rules</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This section demonstrates how to use various traffic management capabilities of Istio.</p>
</div>
<div class="paragraph">
<p>We will show you how to route requests dynamically to multiple versions of a microservice.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_recommendation_v2"><a class="anchor" href="#_deploy_recommendation_v2"></a>Deploy recommendation:v2</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f manifests/kubernetes/recommendation-v2.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait for those pods to show "2/2", the istio-proxy/envoy sidecar is part of that pod</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                 READY     STATUS    RESTARTS   AGE
customer-3600192384-fpljb            2/2       Running   0          17m
preference-243057078-8c5hz           2/2       Running   0          15m
recommendation-v1-60483540-9snd9     2/2       Running   0          12m
recommendation-v2-2815683430-vpx4p   2/2       Running   0          15s</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/4-simple-routing-1.png" alt="4 simple routing 1"></span></p>
</div>
<div class="paragraph">
<p>and test the customer endpoint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl $CUSTOMER_URL</code></pre>
</div>
</div>
<div class="paragraph">
<p>you would likely see <code>"customer =&gt; preference =&gt; recommendation v1 from '99634814-d2z2t': 3"</code>, where '99634814-d2z2t' is the pod running <code>v1</code> and the <code>3</code> is basically the number of times you hit the endpoint.</p>
</div>
<div class="paragraph">
<p>Run again the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>curl $CUSTOMER_URL</code></pre>
</div>
</div>
<div class="paragraph">
<p>you would likely see <code>"customer =&gt; preference =&gt; recommendation v2 from '2819441432-5v22s': 1"</code> as by default you get round-robin load-balancing when there is more than one Pod behind a Service</p>
</div>
<div class="paragraph">
<p>Send several requests to see their responses:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">while true; do curl $CUSTOMER_URL; sleep .5; done</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default Kubernetes behavior is to round-robin load-balance across all available pods behind a single Service. Add another replica of recommendation-v2 Deployment.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/k8s-istio-k8s-istio-4-simple-scale-v2.png" alt="k8s istio k8s istio 4 simple scale v2"></span></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl scale --replicas=2 deployment/recommendation-v2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, you will see two requests into the v2 and one for v1.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">customer =&gt; preference =&gt; recommendation v1 from '2819441432-qsp25': 29
customer =&gt; preference =&gt; recommendation v2 from '99634814-sf4cl': 37
customer =&gt; preference =&gt; recommendation v2 from '99634814-xq3c5': 38</code></pre>
</div>
</div>
<div class="paragraph">
<p>Scale back to a single replica of the recommendation-v2 Deployment</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl scale --replicas=1 deployment/recommendation-v2</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="istiorouting"><a class="anchor" href="#istiorouting"></a>Changing Istio Routings</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before you can use Istio to control version routing, you need to define the available versions, called <em>subsets</em>, in <a href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#DestinationRule">DestinationRule</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kind: DestinationRule
metadata:
  name: recommendation
spec:
  host: recommendation
  subsets:
  - name: version-v1
    labels:
      version: v1
  - name: version-v2
    labels:
      version: v2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run the following command to create default destination rules to send traffic to versions <code>v1</code> and <code>v2</code> of recommandation service.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f manifests/istio/routing-simple/recommendation-destination-rule-v1-v2.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait a few seconds for the destination rules to propagate.</p>
</div>
<div class="paragraph">
<p>You can display the created destination rule with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get destinationrules recommendation -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>To display all destination rules :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get destinationrules -o yaml</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="alltorecommendationv2"><a class="anchor" href="#alltorecommendationv2"></a>Route all the traffic to recommendation:v2</h3>
<div class="paragraph">
<p>To route to one version only, you apply virtual services that set the default version for the microservices. In this case, the virtual services will route all traffic to v2 of recommendation microservice.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/k8s-istio-4-simple-routing-all-v2.png" alt="k8s istio 4 simple routing all v2"></span></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kind: VirtualService
metadata:
  name: recommendation
spec:
  hosts:
  - recommendation
  http:
  - route:
    - destination:
        host: recommendation
        subset: version-v2
      weight: 100</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f manifests/istio/routing-simple/recommendation-virtual-service-v2.yml

curl $CUSTOMER_URL</code></pre>
</div>
</div>
<div class="paragraph">
<p>you should only see v2 being returned</p>
</div>
</div>
<div class="sect2">
<h3 id="alltorecommendationv1"><a class="anchor" href="#alltorecommendationv1"></a>Route all the traffic to recommendation:v1</h3>
<div class="paragraph">
<p><span class="image"><img src="_images/k8s-istio-4-simple-routing-all-v1.png" alt="k8s istio 4 simple routing all v1"></span></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f manifests/istio/routing-simple/recommendation-virtual-service-v1.yml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: recommendation
spec:
  hosts:
  - recommendation
  http:
  - route:
    - destination:
        host: recommendation
        subset: version-v1</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="alltorecommendationv1v2"><a class="anchor" href="#alltorecommendationv1v2"></a>Route the traffic to both versions of recommendation: v1 and v2</h3>
<div class="paragraph">
<p>By simply removing the virtual service</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl delete virtualservice recommendation</code></pre>
</div>
</div>
<div class="paragraph">
<p>and you should see the default behavior of load-balancing between v1 and v2</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl $CUSTOMER_URL</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="canarydeploymentrecommendation"><a class="anchor" href="#canarydeploymentrecommendation"></a>Canary deployment: Split traffic between v1 and v2</h3>
<div class="paragraph">
<p>Canary Deployment scenario: push v2 into the cluster but slowly send end-user traffic to it, if you continue to see success, continue shifting more traffic over time</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/k8s-istio-4-simple-routing-split-90-10.png" alt="k8s istio 4 simple routing split 90 10"></span></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get pods -l app=recommendation

NAME                                  READY     STATUS    RESTARTS   AGE
recommendation-v1-3719512284-7mlzw   2/2       Running   6          2h
recommendation-v2-2815683430-vn77w   2/2       Running   0          1h</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the <code>virtualservice</code> that will send 90% of requests to v1 and 10% to v2</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f manifests/istio/routing-simple/recommendation-virtual-service-v1_and_v2.yml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kind: VirtualService
metadata:
  name: recommendation
spec:
  hosts:
  - recommendation
  http:
  - route:
    - destination:
        host: recommendation
        subset: version-v1
      weight: 90
    - destination:
        host: recommendation
        subset: version-v2
      weight: 10</code></pre>
</div>
</div>
<div class="paragraph">
<p>and send in several requests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">while true; do curl $CUSTOMER_URL; sleep .5; done</code></pre>
</div>
</div>
<div class="paragraph">
<p>In another terminal, change the mixture to be 75/25</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f manifests/istio/routing-simple/recommendation-virtual-service-v1_and_v2_75_25.yml</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_clean_up"><a class="anchor" href="#_clean_up"></a>Clean up</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl delete virtualservice recommendation

kubectl delete destinationrule recommendation</code></pre>
</div>
</div>
</div>
</div>
</div>
</article>
  </main>
</div>
<footer class="footer">
  <p>This content is brought to you by <a href="http://sfeir.com">Sfeir</a></p>
</footer>
<script src="../../../_/js/site.js"></script>
<script src="../../../_/js/vendor/highlight.js"></script>
<script>hljs.initHighlighting()</script>
  </body>
</html>
