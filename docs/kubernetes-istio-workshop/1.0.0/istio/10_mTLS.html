<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mutual TLS :: Kubernetes &amp; Istio Workshop</title>
    <link rel="canonical" href="https://github.com/Sfeir/kubernetes-istio-workshop/kubernetes-istio-workshop/1.0.0/istio/10_mTLS.html">
    <meta name="generator" content="Antora 1.1.1">
    <link rel="stylesheet" href="../../../_/css/site.css">
<link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon">  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a href="#">Kubernetes and Istio Workshop</a>
        <span class="separator">//</span>
        <a href="https://github.com/Sfeir/kubernetes-istio-workshop">Docs</a>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">Project</div>
          <div class="navbar-dropdown">
            <div class="navbar-item"><strong>GitHub</strong></div>
            <a class="navbar-item" href="https://github.com/Sfeir/kubernetes-istio-workshop/">Istio workshop Repository</a>
            <a class="navbar-item" href="https://github.com/Sfeir/kubernetes-istio-workshop//issues">Istio workshop Issue Tracker</a>
          </div>
        </div>
        <a class="navbar-item" href="https://twitter.com/sfeir">
          <span class="icon">
            <svg aria-hidden="true" data-icon="twitter" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
              <path fill="#57aaee" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path>
            </svg>
          </span>
        </a>
      </div>
    </div>
  </nav>
</header>
<div class="main-wrapper">
<div class="navigation-container" data-component="kubernetes-istio-workshop" data-version="1.0.0">
  <aside class="navigation">
    <div class="panels">
<div class="navigation-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Kubernetes and Istio Workshop</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../welcome/welcome.html"><strong>Welcome</strong></a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../welcome/welcome.html#gcp">1. Google Cloud Platform</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../welcome/welcome.html#cloud-shell">2. Setup Cloud Shell</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <span class="nav-text"><strong>Part 1 : Kubernetes</strong></span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../kubernetes/01_setup.html">1. Create cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../kubernetes/02_creating-and-managing-pods.html">2. Pods</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../kubernetes/03_monitoring-and-health-checks.html">3. Monitoring apps</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../kubernetes/04_managing-application-configurations-and-secrets.html">4. ConfigMaps &amp; Secrets</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../kubernetes/05_creating-and-managing-services.html">5. Services</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../kubernetes/06_creating-and-managing-deployments.html">6. Deployments</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../kubernetes/07_rolling-out-updates.html">7. Rolling-upgrade</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../kubernetes/08_cleanup.html">8. Cleanup</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <span class="nav-text"><strong>Part 2 : Istio</strong></span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="01_setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01_setup.html#prerequisites">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01_setup.html#deploy-istio">Deploy Istio</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01_setup.html#connect-cluster">Connect to the cluster</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01_setup.html#verify-installation">Verify installation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="02_deploy-microservices.html">2. Deploy Microservices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02_deploy-microservices.html#deploycustomer">Deploy Customer</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02_deploy-microservices.html#expose-customer">Expose Customer</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02_deploy-microservices.html#deploypreference">Deploy Preference</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02_deploy-microservices.html#deployrecommendation">Deploy Recommendation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="03_monitoring-tracing.html">3. Monitoring and Tracing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03_monitoring-tracing.html#monitoring">Monitoring</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03_monitoring-tracing.html#tracing">Tracing</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="04_simple-routerules.html">4. Simple Routing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04_simple-routerules.html#deployrecommendationv2">Deploy Recommendation V2</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="04_simple-routerules.html#istiorouting">Changing Istio Routings</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="04_simple-routerules.html#alltorecommendationv2">All the traffic to recommendation:v2</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="04_simple-routerules.html#alltorecommendationv1">Al the traffic to recommendation:v1</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="04_simple-routerules.html#alltorecommendationv1v2">All Users To Recommendation V1 and V2</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="04_simple-routerules.html#canarydeploymentrecommendation">Canary Deployment Between v1 And v2</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="05_advanced-routerules.html">5. Advanced Routing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05_advanced-routerules.html#traffic-steering">Traffic Steering</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05_advanced-routerules.html#loadbalancer">Load Balancer</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05_advanced-routerules.html#ratelimiting">Rate Limiting</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="06_fault-injection.html">6. Fault Injection</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06_fault-injection.html#503error">HTTP 503 Error</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06_fault-injection.html#delay">Delay</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06_fault-injection.html#retry">Retry</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06_fault-injection.html#timeout">Timeout</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="07_circuit-breaker.html">7. Circuit Breaker</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="07_circuit-breaker.html#failfast">Fail Fast</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="07_circuit-breaker.html#nocircuitbreaker">No Circuit Breaker</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="07_circuit-breaker.html#circuitbreaker">Circuit Breaker</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="07_circuit-breaker.html#poolejection">Pool Ejection</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="07_circuit-breaker.html#nofailinginstances">No Failing Instance</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="07_circuit-breaker.html#failinginstancesnopoolejection">Failing Instance No Pool Ejection</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="07_circuit-breaker.html#failinginstancespoolejection">Failing Instance Pool Ejection</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="07_circuit-breaker.html#circuitbreakerandpoolejection">Circuit Breaker + Pool Ejection</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="10_mTLS.html">8. Mutual TLS</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#enablingtls">Enabling TLS</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <span class="nav-text"><strong>Bonus</strong></span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="08_egress.html">B1. Egress</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="08_egress.html#createrecommendationv3">Create Recommendation V3</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="08_egress.html#istioegress">Istio-ize Egress</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="09_virtualization.html">B2. Traffic Mirroring</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="09_virtualization.html#deploypreferencev2">Deploy Preference V2</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="09_virtualization.html#virtualize-dependencies">Virtualizing Dependencies</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="09_virtualization.html#mirroring-traffic">Mirroring Traffic</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="11_access-control.html#accesscontrol">B3. Access Control</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="11_access-control.html#whitelist">White List</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="11_access-control.html#blacklist">Black List</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="navigation-explore" data-panel="explore">
  <div class="context">
    <span class="title">Kubernetes and Istio Workshop</span>
    <span class="version">1.0.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Kubernetes and Istio Workshop</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1.0.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
  <main class="main">
<div class="toolbar" role="navigation">
  <button class="navigation-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="crumbs" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="../index.html">Kubernetes and Istio Workshop</a></li>
    <li class="crumb"><strong>Part 2 : Istio</strong></li>
    <li class="crumb"><a href="10_mTLS.html">8. Mutual TLS</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///f/repo/external/github.com/sfeir/kubernetes-istio-workshop/src/documentation/modules/istio/pages/10_mTLS.adoc">Edit this Page</a></div>
</div>
<article class="doc">
<h1>Mutual TLS</h1>
<div class="sect1">
<h2 id="enablingtls"><a class="anchor" href="#enablingtls"></a>Enabling mTLS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now it&#8217;s time to enable <em>mTLS</em> by applying next Istio resources:</p>
</div>
<div class="paragraph">
<p>1 - Enables mTLS into <code>workshop</code> namespace</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f manifests/istio/mutual-tls/authentication-enable-tls-permissive.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>This policy specifies that all workloads in the namespace <code>workshop</code> will only accept encrypted requests using TLS. The name of the policy must be default.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kind: "Policy"
metadata:
  name: "default"
  namespace: "workshop"
spec:
  peers:
  - mtls: {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>2 - At this point, only the receiving side is configured to use mutual TLS. To configure the client side, you need to set destination rules to use mutual TLS. It’s possible to use multiple destination rules, one for each applicable service (or namespace). However, it’s more convenient to use a rule with the * wildcard to match all services in the namesapce.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f manifests/istio/mutual-tls/destination-rule-tls.yml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kind: "DestinationRule"
metadata:
  name: "default"
  namespace: "workshop"
spec:
  host: "*.workshop.svc.cluster.local"
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl http://${GATEWAY_URL}/
customer =&gt; preference =&gt; recommendation v1 from 'b87789c58-mfrhr': 2</code></pre>
</div>
</div>
<div class="paragraph">
<p>And you&#8217;ll see exactly the same but now the communication between the services has been secured.</p>
</div>
<div class="paragraph">
<p>How can you check that?</p>
</div>
<div class="paragraph">
<p>Istio automatically installs necessary keys and certificates for mutual TLS authentication in all sidecar containers. Run command below to confirm key and certificate files exist under <code>/etc/certs</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl exec $(kubectl get pod -l app=recommendation -o jsonpath={.items..metadata.name}) -c istio-proxy -- ls /etc/certs</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cert-chain.pem
key.pem
root-cert.pem</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can alson <em>sniff</em> the traffic between services, which is a bit more tedious, open a new terminal tab and run next command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">CUSTOMER_POD=$(kubectl get pod | grep customer | awk '{ print $1}'| head -1 ) <i class="conum" data-value="1"></i><b>(1)</b>
PREFERENCE_POD=$(kubectl get pod | grep preference | awk '{ print $1}' | head -1) <i class="conum" data-value="1"></i><b>(1)</b>

kubectl exec -it $CUSTOMER_POD -c istio-proxy /bin/bash <i class="conum" data-value="2"></i><b>(2)</b>
kubectl exec -it $PREFERENCE_POD -c istio-proxy /bin/bash

# Inside pod shell

ifconfig <i class="conum" data-value="3"></i><b>(3)</b>

sudo tcpdump -vvvv -A -i eth0 '((dst port 8080) and (net 10.0.3.3))' <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get customer pod name</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Open a shell inside pod</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Get IP of current pod (probably the IP represented at <code>eth0</code> interface)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Capture traffic from <code>eth0</code> (or your interface) of port <code>8080</code> and network <code>10.0.3.3</code> (your IP from <code>ifconfig</code>)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now all communication that happens between <code>customer</code> service and <code>preference</code> service is dumped in the console.</p>
</div>
<div class="paragraph">
<p>So now go to a terminal and execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl http://${GATEWAY_URL}/
customer =&gt; preference =&gt; recommendation v1 from 'b87789c58-mfrhr': 2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Obviously, the response is exactly the same, but if you go to the terminal where you are executing <code>tcpdump</code>, you should see something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">14:24:55.078222 IP (tos 0x0, ttl 64, id 32578, offset 0, flags [DF], proto TCP (6), length 967)
    172.17.0.15.33260 &gt; customer-7dcd544ff9-652ds.8080: Flags [P.], cksum 0x5bf5 (incorrect -&gt; 0x595e), seq 2211080917:2211081832, ack 2232186801, win 391, options [nop,nop,TS val 5958433 ecr 5779275], length 915: HTTP
E....B@.@._........
......j...w.....[......
.Z.!.X/K.............w$.?....&amp;T.`n.....UX.C&amp;)Cj....y..{.&amp;..I..	..&lt;.
.....A..q.;...o.9+.4..;...6|".......M.4Wm.:}.....^..v..2..?VW[&amp;s........@}.~B.&gt;D.k..H...r.... .L..i,.
...=..=..y..[.k..g..0..5.f%..vz|..t.....%.`.|...B..%r0.^k.y.....y.@l$O.....?...J..qc&amp;.........Z.^&amp;..F.....w."&gt;7..	...[.......2.&amp;........&gt;......s.....5
.n$X.....l.#...... ..Q..u..jBI.Z.Eb$9.$.._...!.........~"Xx&lt;....);........Z.
.y/E]......K......... .@s.3.\.
.i.v...#.O&lt;..^.F.	...?..:s...).....e......*..F.Kz..i.jk..xx...#....|.U.!.......X.....@......0.....*...l.v..G)T...9...M.....i.H ..=	.a.hp..&amp;8..L..`.s..d_o.~.T ./.......9..	;F81.......S.{.....1rE..o...`..............c+U...}.{7..Y....Q4.#..(.c]Q...[..8..$u.b...=..6.....~..9..H....R
.9x*q....h0......O......q..Fb)..E..m..=.M.....W.Yk&gt;.......;.2eys..E.....=q.;.k ....R.f.(./^F....4.c..*Y.4....es.....TX`nh..L.z.6....(.X.&gt;c.V.0z........GF%.%..l4P.......@.^Q........46.g.#.n...e.k.._..&gt;.T+.S...t}....</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that you cannot see any detail about the communication since it happened through TLS.</p>
</div>
<div class="paragraph">
<p>Now, let&#8217;s disable <em>TLS</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl delete -f manifests/istio/mutual-tls/authentication-enable-tls.yml
kubectl delete -f manifests/istio/mutual-tls/destination-rule-tls.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>And execute again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl http://${GATEWAY_URL}/
customer =&gt; preference =&gt; recommendation v1 from 'b87789c58-mfrhr': 2</code></pre>
</div>
</div>
<div class="paragraph">
<p>And again check <code>tcpdump</code> output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">host: 0192.168.64.70:31380
user-agent: curl/7.54.0
accept: */*
x-forwarded-for: 172.17.0.1
x-forwarded-proto: http
x-envoy-internal: true
x-request-id: e5c0b90f-341b-9edc-ac3e-7dd8b33f0e8b
x-envoy-decorator-operation: customer.workshop.svc.cluster.local:8080/
x-b3-traceid: ce289e960a639d11
x-b3-spanid: ce289e960a639d11
x-b3-sampled: 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, you can see that since there is no <em>TLS</em> enabled, the information is not shadowed but in clear.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">A last thing about mutual TLS</div>
<div class="paragraph">
<p>If mutual TLS is enabled, http and tcp health checks from the kubelet will not work since the kubelet does not have Istio-issued certificates. In our workshop, we used the port <code>8080</code> for the regular service and also for healthcheck (see below).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kind: Service
metadata:
  name: recommendation
spec:
  ports:
  - name: http
    port: 8080
---
kind: Deployment
metadata:
  labels:
    app: recommendation
    version: v1
  name: recommendation-v1
spec:
...
    spec:
      containers:
      - env:
        ...
        livenessProbe:
          httpGet:
                path: /health
                port: 8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>So before enabling mTLS, you should be aware of this subtlety.</p>
</div>
<div class="paragraph">
<p>On the other hand, Istio supports the <code>PERMISSIVE</code> mode so the services can accept both http and mutual TLS traffic when this mode is turned on. This can solve the health checking issue.</p>
</div>
<div class="paragraph">
<p>As best practice, use a separate port for health check and enable mutual TLS only on the regular service port.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</article>
  </main>
</div>
<footer class="footer">
  <p>This content is brought to you by <a href="http://sfeir.com">Sfeir</a></p>
</footer>
<script src="../../../_/js/site.js"></script>
<script src="../../../_/js/vendor/highlight.js"></script>
<script>hljs.initHighlighting()</script>
  </body>
</html>
